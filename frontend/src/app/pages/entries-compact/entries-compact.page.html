<section class="page">
  <header class="pageHeader">
    <div class="titleBlock">
      <h1>Compact Entries</h1>
      <div class="muted">
        @if (loading()) {
          {{ loadingProgress() || 'Loading‚Ä¶' }}
        } @else {
          Showing {{ items().length }}
          @if (partial()) {
            <span> (partial)</span>
          }
          / {{ totalCount() }}
        }
      </div>
    </div>
    <div class="headerActions">
      <div class="modeToggle">
        <button
          type="button"
          class="modeBtn"
          [class.active]="viewMode() === 'sites'"
          (click)="viewMode.set('sites')"
        >
          General
        </button>
        <button
          type="button"
          class="modeBtn"
          [class.active]="viewMode() === 'reddit'"
          (click)="viewMode.set('reddit')"
        >
          Reddit
        </button>
      </div>

      <input
        class="searchInput"
        type="text"
        placeholder="Search title or URL..."
        [value]="searchQuery()"
        (input)="searchQuery.set($any($event.target).value)"
      />

      <div class="columnConfig">
        <button
          class="iconBtn square"
          type="button"
          title="Fewer columns"
          [disabled]="settings.compactColumns() <= 1"
          (click)="decrementColumns()"
        >
          ‚àí
        </button>
        <span class="columnValue">{{ settings.compactColumns() }}</span>
        <button
          class="iconBtn square"
          type="button"
          title="More columns"
          [disabled]="settings.compactColumns() >= 20"
          (click)="incrementColumns()"
        >
          +
        </button>
      </div>

      <a class="button secondary" routerLink="/entries">Back</a>
    </div>
  </header>

  @if (error()) {
    <div class="error">{{ error() }}</div>
  }

  <div class="scroller" [class.loading]="loading()">
    @if (!loading() && items().length === 0 && !error()) {
      <div class="empty">No entries yet.</div>
    } @else {
      <div class="columns">
        @for (col of columns(); track col.key) {
          <div class="col">
            <div class="colHeader">
              <span class="colTitle">{{ col.label }}</span>
              <span class="colCount">{{ col.count }}</span>
              <div class="sortButtons">
                <button
                  class="sortBtn"
                  type="button"
                  [title]="getDateSortTitle(col.key)"
                  [class.active]="isDateSort(col.key)"
                  (click)="toggleDateSort(col.key)"
                >
                  üìÖ{{ getDateSortIcon(col.key) }}
                </button>
                <button
                  class="sortBtn"
                  type="button"
                  [title]="getNameSortTitle(col.key)"
                  [class.active]="isNameSort(col.key)"
                  (click)="toggleNameSort(col.key)"
                >
                  A{{ getNameSortIcon(col.key) }}
                </button>
                @if (col.key === 'other') {
                  <button
                    class="sortBtn"
                    type="button"
                    [title]="getDomainSortTitle(col.key)"
                    [class.active]="isDomainSort(col.key)"
                    (click)="toggleDomainSort(col.key)"
                  >
                    üåê{{ getDomainSortIcon(col.key) }}
                  </button>
                }
              </div>
            </div>

            <div class="tiles">
              @for (e of col.items; track trackById($index, e)) {
                <div class="tile">
                  <div class="thumb">
                    @if (thumbnailUrl(e)) {
                      <img [src]="thumbnailUrl(e)!" alt="" (error)="onThumbError($event)" />
                    }
                  </div>

                  <div class="text">
                    <div class="title" [title]="e.title || e.url || ''">
                      {{ e.title || e.url || 'Untitled' }}
                    </div>
                  </div>

                  <div class="site">
                    @if (faviconUrl(e)) {
                      <img
                        class="favicon"
                        [src]="faviconUrl(e)!"
                        [title]="siteName(e)"
                        alt=""
                        (error)="onFaviconError($event)"
                      />
                    }
                  </div>

                  <div class="actions">
                    @if (hasYouTubeId(e); as vid) {
                      <button
                        class="iconBtn play"
                        type="button"
                        [title]="'Play video'"
                        (click)="onPlayVideo(vid, $event)"
                      >
                        ‚ñ∂
                      </button>
                    }
                    <button
                      class="iconBtn"
                      type="button"
                      [title]="'Open link: ' + e.url"
                      (click)="openLink(e, $event)"
                    >
                      ‚Üó
                    </button>
                    <a
                      class="iconBtn"
                      title="Go to edit"
                      [routerLink]="['/entries', e.id]"
                      (click)="$event.stopPropagation()"
                    >
                      ‚úé
                    </a>
                    <button
                      class="iconBtn danger"
                      type="button"
                      title="Delete"
                      (click)="deleteEntry(e, $event)"
                    >
                      ‚úñ
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }

    @if (loading() && items().length > 0) {
      <div class="refreshOverlay">Refreshing...</div>
    }
  </div>
</section>

@if (activeVideoId()) {
  <app-video-modal [videoId]="activeVideoId()!" (closeModal)="closeVideo()" />
}
